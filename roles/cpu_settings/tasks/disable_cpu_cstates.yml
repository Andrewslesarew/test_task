- name: Ensure required tools are installed (Debian-based systems)
  ansible.builtin.apt:
    name: grub2-common
    state: present

- name: Backup current GRUB configuration
  ansible.builtin.copy:
    src: /etc/default/grub
    dest: /etc/default/grub.bak
    remote_src: yes
    backup: yes

- name: Read current GRUB configuration
  ansible.builtin.shell: grep "^GRUB_CMDLINE_LINUX=" /etc/default/grub | cut -d'=' -f2- | tr -d '"'
  register: grub_current
  changed_when: false
  become: true

- name: Ensure GRUB_CMDLINE_LINUX contains required kernel parameters
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX='
    line: 'GRUB_CMDLINE_LINUX="{{ updated_grub_cmdline | join(" ") }}"'
  vars:
    current_grub_cmdline: "{{ grub_current.stdout | default('quiet splash') }}"
    required_params:
      - intel_idle.max_cstate=0
      - processor.max_cstate=0
    updated_grub_cmdline: "{{ current_grub_cmdline.split(' ') | union(required_params) }}"
  become: true

- name: Append CPU C-state settings to GRUB_CMDLINE_LINUX_DEFAULT
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT="(.*)"'
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="\1 intel_idle.max_cstate=0"'
    backrefs: yes

- name: Update GRUB configuration
  ansible.builtin.command:
    cmd: update-grub

- name: Reboot the system to apply changes
  ansible.builtin.reboot:
    msg: "Rebooting to apply CPU C-states settings."
    connect_timeout: 5
    reboot_timeout: 300